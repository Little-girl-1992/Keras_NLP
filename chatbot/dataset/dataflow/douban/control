#!/bin/bash

if [ -z $DATAFLOW_DOUBAN_ENV ];then
    ENV=STAGING
else
    ENV=$DATAFLOW_DOUBAN_ENV
fi

cd $(dirname $0)/
cd ..

piddir=~/data/var
logdir=~/data/logs

mkdir -p $piddir
mkdir -p $logdir

echo "env is $ENV"
echo "current dir is:"; pwd
echo "pid dir is $piddir"
echo "log dir is $logdir"

app_scheduler=douban_scheduler
app_crawler_consumer=douban_crawler_consumer
app_struct_to_convs=douban_struct_to_convs


function check_pid() {
    pidfile=$piddir/$1.pid
    if [ -f $pidfile ];then
        pid=`cat $pidfile`
        if [ -n $pid ]; then
            running=`ps -p $pid|grep -v "PID TTY" |wc -l`
            return $running
        fi
    fi
    return 0
}

function start() {
    check_pid $1
    running=$?
    if [ $running -gt 0 ];then
        echo -n "$app now is running already, pid="
        cat $piddir/$1.pid
        return 1
    fi

    DATAFLOW_DOUBAN_ENV=$ENV nohup python -m douban.$1 &>> $logdir/$1.log&
    echo $! > $piddir/$1.pid
    echo "$1 started..., pid=$!"
}

function stop() {
    pgrep -f $1 | xargs kill -9 &>/dev/null
    echo "$1 stoped..."
}

function restart() {
    stop $1
    sleep 1
    start $1
}

function status() {
    check_pid $1
    running=$?
    if [ $running -gt 0 ];then
        echo -n "$1 now is running, pid="
        cat $piddir/$1.pid
    else
        echo "$1 is stoped"
    fi
}

function start_all() {
    start $app_scheduler
    start $app_crawler_consumer
    start $app_struct_to_convs
}

function stop_all() {
    stop $app_scheduler
    stop $app_crawler_consumer
    stop $app_struct_to_convs
}

function restart_all() {
    stop_all
    start_all
}


function help() {
    echo "$0 start app_name|stop app_name|restart app_name|status app_name|restart_all"
}

if [ "$1" == "" ]; then
    help
elif [ "$1" == "stop" ];then
    stop $2
elif [ "$1" == "start" ];then
    start $2
elif [ "$1" == "restart" ];then
    restart $2
elif [ "$1" == "status" ];then
    status $2
elif [ "$1" == "start_all" ];then
    start_all
elif [ "$1" == "stop_all" ];then
    stop_all
elif [ "$1" == "restart_all" ];then
    restart_all
else
    help
fi